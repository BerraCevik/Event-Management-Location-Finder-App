<h2>OpenStreetMap</h2>
<div id="map" style="height: 500px; width: 100%;"></div>
<select id="routeMode" style="margin-top: 10px;">
    <option value="car">Arabayla</option>
    <option value="bike">Bisikletle</option>
    <option value="foot">Yürüyerek</option>
</select>
<button id="drawRoute" style="margin-top: 10px;">Rota Oluştur</button>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<script>
    var konumlar = @Html.Raw(Json.Serialize(ViewData["Konumlar"])); // Konumları alın
    var etkinlikAdlari = @Html.Raw(Json.Serialize(ViewData["EtkinlikAdlari"])); // Etkinlik adlarını alın
    var katilimDurumu = @Html.Raw(Json.Serialize(ViewData["KatilimDurumu"])); // Katılım durumlarını alın

    var map = L.map('map').setView([0, 0], 2);
    var selectedCoordinates = null;
    var userCoordinates = null;

    // OpenStreetMap Tile Layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Renkli işaretçileri tanımlama
    var blueIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // Kullanıcı ve etkinlik konumları
    konumlar.forEach((konum, index) => {
        var coordinates = konum.split(',');
        var marker;
        var iconToUse = greenIcon; // Varsayılan olarak greenIcon

        if (index === 0) {
            // Kullanıcının kendi konumunu yerleştir
            userCoordinates = [parseFloat(coordinates[0]), parseFloat(coordinates[1])];
            marker = L.marker(userCoordinates, { icon: blueIcon }).addTo(map)
                .bindPopup("Buradasınız")
                .openPopup();
        } else {
            // Etkinlik konumlarını yerleştir
            var etkinlikAdi = etkinlikAdlari[index - 1]; // Etkinlik adı, konumlardan bir eksik olacak çünkü kullanıcı konumu ilk sırada

            // Katılım durumuna göre icon belirle
            if (katilimDurumu[index - 1]) {
                iconToUse = greenIcon; // Katıldıkları etkinlikler için greenIcon
            } else {
                iconToUse = redIcon; // Katılmadıkları etkinlikler için redIcon
            }

            marker = L.marker([parseFloat(coordinates[0]), parseFloat(coordinates[1])], { icon: iconToUse }).addTo(map)
                .bindPopup(" " + etkinlikAdi) // Etkinlik adını göster
                .on('click', function () {
                    selectedCoordinates = [parseFloat(coordinates[0]), parseFloat(coordinates[1])];
                    this.openPopup();
                });
        }
    });

    if (konumlar.length > 0) {
        var firstCoordinates = konumlar[0].split(',');
        map.setView([parseFloat(firstCoordinates[0]), parseFloat(firstCoordinates[1])], 13);
    }


    // Routing Machine
    var routeControl = L.Routing.control({
        waypoints: [],
        createMarker: function () { return null; },  // Markerlari engelle
        routeWhileDragging: true
    }).addTo(map);

    // Rota çizmek için butona tıklandığında yapılacak işlem
    document.getElementById('drawRoute').addEventListener('click', function () {
        if (userCoordinates && selectedCoordinates) {
            var mode = document.getElementById('routeMode').value;
            var transportMode;
            console.log("Selected mode:", mode); // Debugging

            // Seçilen moda göre rota tipi belirleme
            if (mode === 'car') {
                transportMode = 'driving'; // OSRM'deki araba modu "driving"
            } else if (mode === 'bike') {
                transportMode = 'cycling'; // OSRM'deki bisiklet modu "cycling"
            } else if (mode === 'foot') {
                transportMode = 'walking'; // OSRM'deki yürüyüş modu "walking"
            } else {
                transportMode = 'driving'; // Varsayılan olarak araba
            }
            console.log("Transport mode:", transportMode); // Debugging

            // CORS Proxy kullanarak URL oluşturuluyor
            var proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            var apiKey = 'YOUR_API_KEY'; // Kendi OpenRouteService API anahtarınızı buraya ekleyin
            var apiUrl = `https://api.openrouteservice.org/v2/directions/${transportMode}?api_key=${apiKey}&start=${userCoordinates[1]},${userCoordinates[0]}&end=${selectedCoordinates[1]},${selectedCoordinates[0]}`;
            var serviceUrl = proxyUrl + apiUrl;

            console.log(`Constructed service URL: ${serviceUrl}`);

            // Rota için mod seçimi
            routeControl.options.router = L.Routing.osrmv1({
                serviceUrl: serviceUrl
            });

            // Rota çizme
            routeControl.setWaypoints([
                L.latLng(userCoordinates[0], userCoordinates[1]),
                L.latLng(selectedCoordinates[0], selectedCoordinates[1])
            ]);

            routeControl.on('routesfound', function (e) {
                console.log("API Response:", e.routes); // Yanıtı konsola yazdır
                if (e.routes.length === 0) {
                    alert("Rota bulunamadı, lütfen tekrar deneyin.");
                } else {
                    console.log("Route found", e.routes);
                }
            });

            // Hata mesajı: Rota için bir yanıt alınamazsa
            routeControl.on('routeerror', function (e) {
                alert("Rota hesaplama hatası: " + e.error);
            });
        } else {
            alert("Lütfen bir etkinlik seçin!");
        }
    });

</script>
